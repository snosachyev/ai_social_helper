version: '3.8'

services:
  # Test databases
  test-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: test_rag
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d test_rag"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  test-redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # Simple mock services for testing
  test-api-gateway:
    image: python:3.9-slim
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./tests/mocks:/app
    command: >
      bash -c "
        cd /app &&
        python -c '
import http.server
import socketserver
import json
from urllib.parse import urlparse, parse_qs

class MockAPIHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/health':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({
                'status': 'healthy',
                'service': 'api-gateway'
            }).encode())
        elif self.path.startswith('/documents'):
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps([]).encode())
        else:
            self.send_response(404)
    
    def do_POST(self):
        if self.path == '/documents/upload':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({
                'success': True,
                'document_id': 'test-doc-id',
                'message': 'Document uploaded successfully'
            }).encode())
        else:
            self.send_response(404)

with socketserver.TCPServer(('', 8000), MockAPIHandler) as httpd:
    print(\"Mock API Gateway running on port 8000\")
    httpd.serve_forever()
        '
      "
    depends_on:
      - test-postgres
      - test-redis
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  test-embedding-service:
    image: python:3.9-slim
    ports:
      - "8002:8002"
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./tests/mocks:/app
    command: >
      bash -c "
        cd /app &&
        python -c '
import http.server
import socketserver
import json
import uuid

class MockEmbeddingHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/health':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({
                'status': 'healthy',
                'service': 'embedding-service'
            }).encode())
        elif self.path == '/models':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps([]).encode())
        else:
            self.send_response(404)
    
    def do_POST(self):
        if self.path == '/embeddings/generate':
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({
                'vector_id': str(uuid.uuid4()),
                'chunk_id': 'test-chunk-id',
                'embedding': [0.1] * 384,
                'model_name': 'test-model',
                'dimension': 384,
                'created_at': '2024-01-01T00:00:00Z'
            }).encode())
        else:
            self.send_response(404)

with socketserver.TCPServer(('', 8002), MockEmbeddingHandler) as httpd:
    print(\"Mock Embedding Service running on port 8002\")
    httpd.serve_forever()
        '
      "
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  test-network:
    driver: bridge
