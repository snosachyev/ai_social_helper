# Production configuration with proper image building
version: '3.8'

services:
  # Production builds with proper multi-stage Dockerfiles
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/api-gateway:${VERSION:-latest}
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/auth-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  document-service:
    build:
      context: .
      dockerfile: services/document-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/document-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  embedding-service:
    build:
      context: .
      dockerfile: services/embedding-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/embedding-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 4G
          cpus: '1.0'
        reservations:
          memory: 2G
          cpus: '0.5'

  retrieval-service:
    build:
      context: .
      dockerfile: services/retrieval-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/retrieval-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  generation-service:
    build:
      context: .
      dockerfile: services/generation-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/generation-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 8G
          cpus: '2.0'
        reservations:
          memory: 4G
          cpus: '1.0'

  vector-service:
    build:
      context: .
      dockerfile: services/vector-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/vector-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  telegram-service:
    build:
      context: .
      dockerfile: services/telegram-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/telegram-service:${VERSION:-latest}
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  model-service:
    build:
      context: .
      dockerfile: services/model-service/Dockerfile
      target: runtime
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: rag-system/model-service:${VERSION:-latest}
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 8G
          cpus: '2.0'
        reservations:
          memory: 4G
          cpus: '1.0'
